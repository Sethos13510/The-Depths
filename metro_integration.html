<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Instructions d'int√©gration Trame M√©tro</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
            max-width: 1000px;
        }
        h1, h2, h3 {
            color: #333;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            overflow-x: auto;
        }
        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>Instructions d'int√©gration de la Trame M√©tro</h1>
    
    <div class="warning">
        <strong>Important :</strong> Les modifications suivantes doivent √™tre appliqu√©es pour assurer la communication correcte entre les composants pour les √©v√©nements de la trame m√©tro.
    </div>
    
    <h2>1. Modifications dans sethos_ai.html</h2>
    <p>Assurez-vous que le fichier story_events.js est inclus apr√®s Three.js :</p>
    <pre>
    &lt;!-- Charger Three.js --&gt;
    &lt;script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"&gt;&lt;/script&gt;
    
    &lt;!-- Charger le gestionnaire d'√©v√©nements story --&gt;
    &lt;script src="story_events.js"&gt;&lt;/script&gt;
    
    &lt;script&gt;
        // Le reste du script...
    </pre>
    
    <h2>2. Modifications dans new_admin.html</h2>
    <p>La fonction sendGameAction a √©t√© modifi√©e pour envoyer les √©v√©nements au serveur via Socket.IO :</p>
    <pre>
    function sendGameAction(type, params) {
        // V√©rifier si Socket.IO est disponible
        if (typeof socket === 'undefined' || !socket) {
            console.error('Socket.IO non initialis√©. Tentative de connexion...');
            connectSocket();
            setTimeout(() => {
                if (socket && socket.connected) {
                    sendGameAction(type, params);
                } else {
                    addLogEvent('Erreur: Impossible de se connecter au serveur.', 'error');
                }
            }, 1000);
            return false;
        }
        
        // Pr√©parer les donn√©es de l'action
        const actionData = {
            type: type,
            ...params,
            timestamp: Date.now()
        };
        
        console.log('Envoi de l\'action au jeu:', actionData);
        
        // Envoyer l'action au serveur
        socket.emit('game_action', actionData);
        
        // √âgalement envoyer une notification au serveur pour mettre √† jour les clients sethos_ai.html
        socket.emit('metro_event', actionData);
        
        addLogEvent(`Action envoy√©e au jeu: ${type}`, 'action');
        
        return true;
    }
    </pre>
    
    <h2>3. Modifications dans server.js</h2>
    <p>Le serveur a √©t√© modifi√© pour √©couter les √©v√©nements metro_event et les ajouter √† la file d'attente des mises √† jour :</p>
    <pre>
    // Configuration des √©v√©nements Socket.IO
    io.on('connection', (socket) => {
      console.log('Client connect√©:', socket.id);
      systemState.activeUsers++;
      
      // ... code existant ...
      
      // √âcouter les √©v√©nements de la trame m√©tro (boat et door)
      socket.on('metro_event', (data) => {
        console.log('√âv√©nement m√©tro re√ßu:', data);
        
        // S'assurer que la file d'attente des mises √† jour existe
        if (!systemState.pendingStoryUpdates) {
          systemState.pendingStoryUpdates = [];
        }
        
        // Ajouter l'√©v√©nement √† la file d'attente pour sethos_ai.html
        systemState.pendingStoryUpdates.push({
          action: 'triggerEvent',
          eventType: data.type,
          parameters: data,
          duration: data.duration || 0
        });
        
        // Informer tous les clients de l'√©v√©nement
        io.emit('metro_update', data);
        
        console.log('√âv√©nement m√©tro ajout√© √† la file d\'attente pour sethos_ai.html');
      });
    });
    </pre>
    
    <h2>4. Modifications dans story_events.js</h2>
    <p>Le fichier story_events.js a √©t√© cr√©√©/modifi√© pour traiter correctement les √©v√©nements de la trame m√©tro :</p>
    <pre>
    function checkServerUpdates() {
        // ... code existant ...
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.updates && data.updates.length > 0) {
                    // Traiter les mises √† jour
                    data.updates.forEach(update => {
                        // ... code existant ...
                        
                        switch (update.action) {
                            // ... cas existants ...
                            
                            case 'triggerEvent':
                                // ... code existant ...
                                
                                // Traitement sp√©cial pour les √©v√©nements de la trame m√©tro
                                if (update.eventType === 'boat') {
                                    console.log('üü£ SETHOS - Traitement √©v√©nement bateau:', update.parameters);
                                    handleBoatAction(update.parameters);
                                } else if (update.eventType === 'door') {
                                    console.log('üü£ SETHOS - Traitement √©v√©nement porte:', update.parameters);
                                    handleDoorAction(update.parameters, update.duration);
                                }
                                break;
                                
                            case 'metro_update':
                                // Traiter sp√©cifiquement les √©v√©nements de la trame m√©tro
                                if (update.type === 'boat') {
                                    console.log('üü£ SETHOS - Traitement √©v√©nement bateau:', update);
                                    handleBoatAction(update);
                                } else if (update.type === 'door') {
                                    console.log('üü£ SETHOS - Traitement √©v√©nement porte:', update);
                                    handleDoorAction(update, update.duration);
                                }
                                break;
                            
                            // ... autres cas ...
                        }
                    });
                }
            });
    }
    
    // Les fonctions handleBoatAction et handleDoorAction ont √©t√© am√©lior√©es
    // pour interagir directement avec le bateau et les portes 3D dans sethos_ai.html.
    </pre>
    
    <div class="success">
        <strong>R√©sultat :</strong> Avec ces modifications, les √©v√©nements de la trame m√©tro seront correctement communiqu√©s entre new_admin.html et sethos_ai.html via le serveur. Les animations de porte et les mouvements du bateau fonctionneront correctement.
    </div>
    
    <h2>Comment tester</h2>
    <ol>
        <li>D√©marrer le serveur (server.js)</li>
        <li>Ouvrir new_admin.html dans un navigateur</li>
        <li>Ouvrir sethos_ai.html dans un autre onglet</li>
        <li>Dans new_admin.html, cr√©er et d√©clencher des √©v√©nements de porte ou de bateau</li>
        <li>V√©rifier que les √©v√©nements sont bien transmis √† sethos_ai.html et que les animations se d√©clenchent</li>
    </ol>
</body>
</html> 